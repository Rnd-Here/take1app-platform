name: Build and Deploy

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

permissions:
  contents: read
  packages: write

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    outputs:
      owner_lc: ${{ steps.set_owner.outputs.owner_lc }}

    steps:
      - uses: actions/checkout@v6

      - name: Set lowercase repository owner
        id: set_owner
        run: echo "owner_lc=$(echo ${{ github.repository_owner }} | tr '[:upper:]' '[:lower:]')" >> $GITHUB_OUTPUT

      - name: Set up JDK 17
        uses: actions/setup-java@v5
        with:
          java-version: "17"
          distribution: "temurin"
          cache: maven

      - name: Build with Maven
        run: mvn -B package -DskipTests --file pom.xml

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push Docker image
        uses: docker/build-push-action@v6
        with:
          context: .
          push: true
          tags: |
            ghcr.io/${{ steps.set_owner.outputs.owner_lc }}/take-one-app-backend:latest
            ghcr.io/${{ steps.set_owner.outputs.owner_lc }}/take-one-app-backend:${{ github.sha }}

  deploy:
    needs: build-and-push
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'

    steps:
      - uses: actions/checkout@v6 # To get the docker-compose.yml file

      - name: Deploy to VPS using SSH
        uses: appleboy/ssh-action@v1.2.4
        env:
          FIREBASE_SECRET: ${{ secrets.TAKE_ONE_APP_FIREBASE_SERVICE_ACCOUNT_JSON }}
          IMAGE_NAME: ghcr.io/${{ needs.build-and-push.outputs.owner_lc }}/take-one-app-backend:latest
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USERNAME }}
          key: ${{ secrets.VPS_SSH_KEY }}
          envs: FIREBASE_SECRET,IMAGE_NAME
          script: |
            set -eux
            echo "Starting deployment to ${{ vars.PROJECT_PATH }}..."

            # Navigate to project directory
            mkdir -p ${{ vars.PROJECT_PATH }}
            cd ${{ vars.PROJECT_PATH }}

            echo "Generating configuration files..."
            # Login to GHCR on VPS (requires a PAT with read:packages if private)
            # If the repo is public, login might not be strictly necessary for pulling.
            # echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin

            # Create/Update .env file
            echo "FIREBASE_CONFIG_BASE64=$FIREBASE_SECRET" > .env
            echo "IMAGE_NAME=$IMAGE_NAME" >> .env

            echo "Updating docker-compose.yml..."
            # We need the docker-compose.yml on the server. 
            # Since we avoid git pull, we can either scp it or use a heredoc.
            # For simplicity in this script, we'll use a heredoc to write the minimal compose.

            cat <<EOF > docker-compose.yml
            version: '3.8'
            services:
              app:
                image: $IMAGE_NAME
                ports:
                  - "8080:8080"
                environment:
                  - DB_URL=jdbc:mysql://mysql:3306/take1app?useSSL=false&allowPublicKeyRetrieval=true&serverTimezone=UTC
                  - DB_USERNAME=root
                  - DB_PASSWORD=root
                  - REDIS_HOST=redis
                  - REDIS_PORT=6379
                  - FIREBASE_CONFIG_PATH=/app/firebase-service-account.json
                  - APP_FIREBASE_CONFIG_BASE64=\${FIREBASE_CONFIG_BASE64}
                depends_on:
                  mysql:
                    condition: service_healthy
                  redis:
                    condition: service_healthy
                networks:
                  - takeone-network
                restart: unless-stopped

              mysql:
                image: mysql:8.0
                ports:
                  - "3306:3306"
                environment:
                  MYSQL_ROOT_PASSWORD: root
                  MYSQL_DATABASE: take1app
                healthcheck:
                  test: [ "CMD", "mysqladmin", "ping", "-h", "localhost" ]
                  timeout: 20s
                  retries: 10
                volumes:
                  - mysql_data:/var/lib/mysql
                networks:
                  - takeone-network
                restart: unless-stopped

              redis:
                image: redis:alpine
                ports:
                  - "6379:6379"
                healthcheck:
                  test: [ "CMD", "redis-cli", "ping" ]
                  interval: 10s
                  timeout: 5s
                  retries: 5
                networks:
                  - takeone-network
                restart: unless-stopped

            volumes:
              mysql_data:

            networks:
              takeone-network:
                driver: bridge
            EOF

            # Detect if 'docker compose' or 'docker-compose' is available
            if docker compose version > /dev/null 2>&1; then
              COMPOSE_CMD="docker compose"
            else
              COMPOSE_CMD="docker-compose"
            fi
            echo "Using compose command: $COMPOSE_CMD"

            echo "Pulling latest images from GHCR..."
            $COMPOSE_CMD pull

            echo "Restarting containers..."
            $COMPOSE_CMD up -d

            echo "Deployment finished successfully!"
